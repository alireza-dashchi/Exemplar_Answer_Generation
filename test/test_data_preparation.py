import sys
import os

# Add the parent directory to the system path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

import pytest
import pandas as pd
from data_preparation import split_data, save_formatted_data
import os
import json

# Sample test data
sample_data = [
    {
		"question_id" : "8b1d6474-a38a-4456-8ac2-74ff054b9d67",
		"task_id" : "41f89fd8-0d25-4aa7-848c-6840f01023da",
		"question" : "Which fin design worked best? Why?",
		"rubric" : "{\"items\": [\"I can explain my response\", \"I can identify which fin design worked best\", \"No evidence\"], \"criteria\": \"Decide which variables should be changed, measured and controlled in fair tests and accurately observe, measure and record data\", \"total_score\": \"2\", \"curriculum_codes\": {\"au\": [\"AC9S5I03\", \"VCSISU084\", \"ST3-1WS-S\"]}}",
		"answer" : "\"Fin designs that have three or four triangular fins that are at the base end of the rocket work best. They stabilise the rocket and make it more aerodynamic or streamlined\"",
		"task_title" : "Designing your rocket",
		"task_content" : "Designing your rocket    Building phase     The shape, weight, and size of a rocket, and it’s design of nose cone and fins, all affect how aerodynamic or efficient it will be.&nbsp;    Being efficient allows a rocket to use less fuel while travelling long distances or overcoming gravity to take off and escape our atmosphere.&nbsp;    Rockets need to go straight up when launching and not veer to one side or roll when travelling through space. An effective  nose cone  and  fins  will help to stabilise your rocket.&nbsp;    So, to create a rocket that can be launched into space, you must design:     A rocket body    Fins &amp; a nose cone    A final rocket design with all elements     In your teams, you must:     Design your nose cones and fins\/tail. Think about which materials to use and how to attach them before constructing their designs    Two team members could construct the nose cone and the other two could construct the fins\/tail design. Your team needs to ensure that the canister lid is kept clear so that it can still come away from the canister during the launch    You will need to do two trials of each (or more if there are launching issues). You should note whether the rocket launched straight up and if their rocket was rolling or was stable. Something being even a fraction off can be the difference between your mission of getting to space succeeding or ending in disaster    You can also have a free design option where you may want to try covering the whole canister with cardboard         Materials         Film canister (or empty water bottle and lid) for the rocket    Protective clothing and safety glasses      Cardboard (of various thickness &amp; textures)    Scissors      Glue or tape (strong tape preferred)    Pencil or pen      Rocket ‘fuel’ from the previous task - baking soda, vinegar, measuring spoons, and water    Paper towel        Do you think you should prioritise height or the straightness of your rocket’s flight?  Explain your answer   What factors did you have to keep the same in each trial? Why?   Suggest one way in which this experiment could be improved   Which nose cone design worked best? Why?   Make an annotated (labelled) diagram showing your best nose cone and fin designs on your rocket. Make sure that you label each part and explain the feature\/features of these parts, what these were made from, and how you attached them to your rocket   Which fin design worked best? Why? "
	},
	{
		"question_id" : "8add417a-4108-43e6-b033-4fa72ac4f709",
		"task_id" : "35d95305-bc3a-461a-ba96-83063257f32d",
		"question" : "Which planet had the fastest and slowest orbits? How long are they and why do you think this occurs?",
		"rubric" : "{\"items\": [\"I can explain why these planets have the fastest and slowest orbits\", \"I can identify which planet has both the fastest or the slowest orbit, and how long that orbit is\", \"I can identify which planet has either the fastest or the slowest orbit, and how long that orbit is\", \"No evidence\"], \"criteria\": \"Earth is part of a system of planets orbiting around a star (the Sun)\", \"total_score\": \"3\", \"curriculum_codes\": {\"au\": [\"AC9S6U02\", \"VCSSU078\", \"ST3-10ES-S\"]}}",
		"answer" : "\"Mercury has the fastest orbit of 88 days. This happens as it is the closest planet to the Sun. Neptune has the slowest orbit of 60,190 days. This happens as it is the furthest planet from the Sun\"",
		"task_title" : "The orbits of other planets",
		"task_content" : "The orbits of other planets    The orbits of other planets     All of the other planets in our solar system also orbit or revolve around the Sun.&nbsp;    Check out     NASA's live solar system         feature to have a look at the path each planet takes as it orbits around the sun. Can you find each of the planets in our solar system? Make sure   you zoom in and out to find them all!    We have already looked at Earth's orbit in detail. Each planet has its own peculiar orbit around the Sun. They are all slightly different from Earth's.       Orbits of Solar System Planets             Planet        Axial tilt        Orbit details        Seasons        Day length        Year length          Mercury       2 degrees      Egg-shaped. Between 47 and 70 million kms from the Sun      Small angle tilt means Mercury revolves the Sun almost perfectly upright. No real seasons      58 Earth days      88 Earth days         Venus       3 degrees      Nearly a perfect circle      Small angle tilt means Venus revolves the Sun almost perfectly upright. No real seasons      243 Earth days      225 Earth days         Earth       23.5 degrees      Nearly circular      Every 90-93 Earth days. Warmer and colder temperatures experienced at opposite times by northern and southern hemispheres      23.9 Earth hours      365.25 Earth days         Mars       24 degrees      Egg-shaped      Vary in length depending on orbit around Sun. ‘Spring’ in the northern hemisphere is around 194 Mars days, whereas autumn is 142 Mars days      24 Earth hours and 37 minutes      687 Earth days         Jupiter       3 degrees      Oval-shaped. Parts of its orbit are 75 million km closer to the Sun than others      Conditions change roughly every three Earth years (coinciding with the distance from the Sun in its orbit)      9 Earth hours and 56 minutes      4,333 Earth days         Saturn       26.75 degrees      Oval-shaped      Conditions change roughly every seven Earth years (coinciding with the distance from the Sun in its orbit)      17 Earth hours and 14 minutes      10,759 Earth days         Uranus       97.8 degrees      Oval-shaped. Parts of its orbit are 270 million km closer to the Sun than others      About every 20 Earth years.    Uranus is the only planet whose equator is nearly at a right angle to its orbit. This unique tilt causes the most extreme seasons in the solar system. For nearly a quarter of each Uranian year, the Sun shines directly over each pole, plunging the other half of the planet into a 21-year-long, dark winter      17 Earth hours and 14 minutes      30,687 Earth days         Neptune       28.5 degrees      Oval-shaped      Change once every 40 years or so      16 Earth hours and 6 minutes      60,190 Earth days        &nbsp;    Demonstrating the orbits of other planets     Materials        Torches or a lamp (to represent the Sun)    Cameras for filming\/taking photos      A ball or balloon (to represent the planet) or material to make a ball from (like Play-Doh)    A darkened space      Wooden skewers for the planet’s axis (but not if the planet is being modelled with a balloon!)   &nbsp;      You may need to ask (in advance) for any other specific materials which you need to complete their task   Method    Choose a planet other than Earth. Your team must model its orbit!    Using the same demonstration method as you did for your Earth’s orbit, demonstrate the orbit of your planet.&nbsp;    You can demonstrate your knowledge and understanding by making a short film, an enactment, or a model of the planet’s orbit. You’ll need to include:     an accurate axis tilt    the shape of the planet’s orbit    whether the planet experiences seasons like we do on Earth    whether your planet ever comes close to Earth when they are both orbiting the Sun     Once all groups have completed this task, it may be possible for all the groups to get together to coordinate a complete solar system with all planets orbiting around a sun. Distance is not being considered in this activity, just speed, so you would just need to try and determine how fast or slow their planet was orbiting around the Sun compared with Earth.     Share a video, photos, or explanation of the model your team made    Which planet had the fastest and slowest orbits? How long are they and why do you think this occurs?   Which planet has no tilted axis? Which planet has the most tilted axis? How does this affect these planets? &nbsp; "
	},
	{
		"question_id" : "89edd167-18ed-40ba-93f1-93999a800097",
		"task_id" : "c4c7058a-5f65-45a2-b097-30733070e4bd",
		"question" : "Based on your results (ie. shape, volume, and compressibility), what are the three properties of:Solids?Liquids?Gases?",
		"rubric" : "{\"items\": [\"I can identify the three properties of all of a solid, liquid, and gas\", \"I can identify the three properties of two of a solid, liquid, or gas\", \"I can identify the three properties of one of a solid, liquid, or gas\", \"No evidence\"], \"criteria\": \"Use particle theory to describe the arrangement of particles in a substance, including the motion of and attraction between particles, and relate this to the properties of the substance\", \"total_score\": \"3\", \"curriculum_codes\": {\"au\": [\"AC9S7U05\", \"VCSSU096\", \"SC4-16CW\"]}}",
		"answer" : "\"Exemplar AnswerSolids - shape did not change, volume did not change, and it was not able to be compressedLiquids - shaped changed to that of the container, volume did not change, and it was only able to be compressed slightlyGases - shape changed to that of the container, volume changed to fit the container, and it was able to be compressed a lot\"",
		"task_title" : "What are objects made of?",
		"task_content" : "What are objects made of?    What affects whether or not something floats?    Some things float and others don't. Why is that? What is it about an object which affects whether or not it floats?  Do you think there are consistent rules or principles for why an object floats or sinks which can be applied across all objects? Should we be able to predict with precision whether an object floats or sinks just by looking at it (or holding it)? Or is completely random?  Let's start with creating some hypotheses about why objects float or sink. To do this:   First, create a hypothesis (or some hypotheses) for whether or not there are rules governing if an object sinks or floats. Explain how you could test this to see if it's true or not  Your teacher will then show you a selection of fruits and vegetables (or other objects). Predict which of these will float and which will sink, based on your hypothesis    Save a photo of your completed atom model here.  Annotate your model or explain it here. What does each part of the model represent?   How does the particle model help us explain the difference in how solids, liquids, and gases can be (or can't) be compressed?   How does the particle model help us explain the difference in how solids, liquids, and gases can be (or can't) be compressed?    How does the particle model help us explain the difference in the shape of solids, liquids, and gases?    Save a photo of your completed atom model here.  Annotate your model or explain it here. What does each part of the model represent?   Save a photo of your completed atom model here.  Annotate your model or explain it here. What does each part of the model represent?   Based on your results (ie. shape, volume, and compressibility), what are the three properties of:   Solids?  Liquids?  Gases?    Refine your initial hypothesis based on these results.  What do you  now  think affects whether or not an object sinks or floats?    How does the particle model help us explain the difference in the shape of solids, liquids, and gases?    How does the particle model help us explain the difference in how solids, liquids, and gases can be (or can't) be compressed?   Based on your results (ie. shape, volume, and compressibility), what are the three properties of:   Solids?  Liquids?  Gases?    Using what you know about the particle model, can you begin to guess what might affect whether an object sinks or floats?  Refine and explain your new hypothesis   Save a photo of your completed atom model here.  Annotate your model or explain it here. What does each part of the model represent?   Save a photo of your completed atom model here.  Annotate your model or explain it here. What does each part of the model represent?   Save a photo of your completed atom model here.  Annotate your model or explain it here. What does each part of the model represent?   Based on your results (ie. shape, volume, and compressibility), what are the three properties of:   Solids?  Liquids?  Gases?     How does the particle model help us explain the difference in the shape of solids, liquids, and gases?  "
	},
	{
		"question_id" : "8632c092-ea9f-4ba2-bdfa-d2f335c95247",
		"task_id" : "cb21ad07-eed4-49a4-9d63-5e266a0b19b0",
		"question" : "Determine the ratio of the load force to effort force in this experiment. This is the same ratio as the mass of the load to the mass of effort",
		"rubric" : "{\"items\": [\"I can explain how we know this\", \"I can calculate the ratio of the load force to effort force in this experiment\", \"No evidence\"], \"criteria\": \"Use scientific knowledge and findings from investigations to identify relationships, evaluate claims and draw conclusions\", \"total_score\": \"2\", \"curriculum_codes\": {\"au\": [\"AC9S7I07\", \"VCSIS111\", \"SC4-7WS\"]}}",
		"answer" : "\"The ratio of the load force to the effort force is 2:1\"",
		"task_title" : "Forces in action - seesaws",
		"task_content" : "Forces in action - seesaws    Turning forces     Objects can turn around a fixed point called the fulcrum or the  pivot . The force applied to turn the objects around the pivot or the turning force is called the  moment , or  torque .       Turning Forces       The torque or the turning force is calculated by multiplying the applied force (in N) by the distance (in metres) of the applied force from the pivot. It is shown by the formula below:     Turning force (moment\/torque) = Force x distance from the pivot     Turning force is measured using  Newton-metres (Nm) .   &nbsp;    Levers      First class levers  are simple machines which have the pivot between the force and the load. This allows a larger force to be applied to the load with less effort.    The effort force moves over a larger distance to move the load force over a smaller distance. As the ratio of effort (force) arm length to load arm length increases, the mechanical advantage of a first class lever increases.       How Levers Work       Seesaws used in playgrounds are an example of first class levers. The turning forces can be balanced around a seesaw pivot by adjusting the distance each person sits from the pivot.&nbsp;   &nbsp;    Experiment      Aim     To explore how load and effort forces can be balanced when using levers     Materials         &nbsp;1-metre ruler    200g mass to act as the load      A retort stand to act as the pivot    100g mass to act as the effort       &nbsp;    Method      Balance the ruler on the top of the retort stand (or its outstretched arm) to create a pivot. Ensure the ruler is balanced    While the ruler is balanced on its pivot point tie the 200g mass at the 70cm mark on the ruler. Hold the other end of the ruler so it does not fall and  do not let the pivot point change     Tie the 100g mass on the other side of the pivot. Move the mass up and down the ruler until it is balanced    Record the effort distance and the load distance from the pivot in the results table    Remove the weights. Repeat Step 2 but this time tie the 200g mass at the 60cm mark on the ruler    Repeat Steps 3 &amp; 4. Remember,  do not let the pivot point change         Are the forces balanced on both sides of the lever (ruler) when it is resting on its pivot? Explain   How might your findings affect the design of a seesaw in a playground?   Determine the ratio of the load distance to effort distance in this experiment   With balancing of load and effort forces in mind, devise a hypothesis for your experiment   Determine the ratio of the load force to effort force in this experiment. This is the same ratio as the mass of the load to the mass of effort   Use your results to explain the relationship between load distance and the effort distance from the pivot when the load force is considerably larger than the effort force "
	},
	{
		"question_id" : "8422d140-5d31-4933-ae45-52f380e1213a",
		"task_id" : "fe99ba29-d69a-4231-8a66-badedae898b2",
		"question" : "Describe the shape of the Earth’s orbit around the Sun",
		"rubric" : "{\"items\": [\"I can explain the shape of the Earth's orbit\", \"I can describe the shape of the Earth's orbit\", \"No evidence\"], \"criteria\": \"Earth is part of a system of planets orbiting around a star (the Sun)\", \"total_score\": \"2\", \"curriculum_codes\": {\"au\": [\"AC9S6U02\", \"VCSSU078\", \"ST3-10ES-S\"]}}",
		"answer" : "\"The Earth’s orbit around the Sun is an elliptical or oval shape. This means that the Earth is sometimes closer to the Sun than at other times\"",
		"task_title" : "Earth's orbit",
		"task_content" : "Earth's orbit    What is an orbit?     An orbit is a regular, repeating path that one object (such as a planet) in space takes around another object (like the sun). All of the eight planets in our solar system revolve or orbit around the Sun. These revolutions or orbits vary greatly and can affect the seasons and general weather conditions found on each planet.    Orbits come in different shapes. All orbits are  elliptical , which means they are an ellipse, similar to an oval.&nbsp;      The Earth's orbit     Our Earth revolves or orbits around the Sun every 365 and ¼ days. This extra ¼ of a day adds up to a full day every 4 years (¼ + ¼+ ¼ + ¼ = 1) and is why we have a  leap year  with an extra day every 4 years. Our orbit, along with the tilt of the axis of the Earth, creates our seasons and allows us to live in most parts of the world.&nbsp;       Earth's Orbit         &nbsp;    Demonstrating Earth's orbit     Materials        Torches or a lamp (to represent the Sun)    Cameras for filming\/taking photos      A ball (to represent the Earth) or material to make a ball from (like Play-Doh)    A darkened space      Wooden skewers for the Earth’s axis   &nbsp;      You may need to ask (in advance) for any other specific materials which you need to complete their task   Method    Together with your team, you must create a demonstration of how the Earth revolves around the sun. Be creative and have fun with it!&nbsp;    You could make a short film, a model, or do a visual demonstration using objects, your team mates, and all the space you have.    Your demonstration should include all of the following:     An accurate elliptical (oval) shape of our orbit    An accurate representation of the tilt of our Earth’s axis    An explanation of how we get our seasons&nbsp;    An explanation of why our seasons are the opposite of each other in the two hemispheres and what the solstices and equinoxes are     Explain why the Northern Hemisphere will have summer when the Southern Hemisphere will have winter   Why is the tilt of the Earth’s axis so important when it comes to our seasons?   HINT : Try modelling the Earth’s orbit without the Earth having the tilting axis - what happens? &nbsp;   Describe the shape of the Earth’s orbit around the Sun   Share a video, photos, or explanation of the model your team made "
	}
]


# Test for split_data function with empty data
def test_split_data_empty_file(tmpdir):
    file_path = tmpdir.join("empty.json")
    with open(file_path, 'w') as f:
        json.dump([], f)  # Write empty list to simulate empty data

    split_data(file_path, 'train_data.json', 'test_data.json', 'holdout_data.json')
    assert os.path.exists('train_data.json')
    assert os.path.exists('test_data.json')
    assert os.path.exists('holdout_data.json')
    # Check if generated files are empty
    assert pd.read_json('train_data.json', lines=True).empty
    assert pd.read_json('test_data.json', lines=True).empty
    assert pd.read_json('holdout_data.json', lines=True).empty

# Test for split_data function with invalid JSON format
def test_split_data_invalid_json(tmpdir):
    file_path = tmpdir.join("invalid.json")
    with open(file_path, 'w') as f:
        f.write("{invalid_json}")  # Write invalid JSON to simulate error

    with pytest.raises(json.JSONDecodeError):
        split_data(file_path, 'train_data.json', 'test_data.json', 'holdout_data.json')

# Test for save_formatted_data function with empty DataFrame
def test_save_formatted_data_empty_df(tmpdir):
    df = pd.DataFrame()  # Empty DataFrame
    output_file = tmpdir.join("formatted_train_data.jsonl")
    save_formatted_data(df, output_file)
    assert os.path.exists(output_file)
    with open(output_file) as f:
        lines = f.readlines()
    assert len(lines) == 0  # Expect no lines in output file
